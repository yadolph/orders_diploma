# API для маркетплейса
## Руководство по использованию

### 0.1 OpenAPI
Автоматически сгенерированная схема OpenAPI для Postman доступна по адресу:
https://documenter.getpostman.com/view/13405465/TVeiDr4P

### 1. Установка и первоначальная настройка
**1.1. Склонируйте данный репозиторий себе на локальную машину:**
```
git clone https://github.com/yadolph/orders_diploma.git
```
При необходимости создайте в папке виртуальное окружение.

**1.2. Установите все зависимости, для этого находясь в папке orders_diploma выполните команду в терминале:**
```
pip install -r requirements.txt
```
Примечание: Здесь и далее будут использованы команды pip и python, используйте их или pip3 и python3, в зависимости от вашей системы

**1.3. Проведите миграции БД**
 ```
python manage.py migrate
```
**1.4 Опционально - в файле orders/settings.py заполните блок настроек отправки электронной почты,** если хотите, чтобы система отправляла письма. Функция отправки почты имеет параметр fail_silently=True, поэтому в случае, если вы не заполните эти параметры, ничего не произойдет, просто письма при подтверждении регистрации и заказа отправляться не будут.
 ```
EMAIL_HOST = 'smtp.yandex.ru'
EMAIL_PORT = '465'
EMAIL_HOST_USER = 'имя пользователя'
EMAIL_HOST_PASSWORD = 'ваш пароль'
EMAIL_USE_SSL = True
EMAIL_FROM = 'от кого письмо?'
```

**1.5 Celery**

Данный API маркетплейса использует фреймворк Celery для медленных задач - отправка e-mail, загрузка данных от поставщика.

Чтобы обеспечить его работоспособность, на вашей локальной машине или на сервере должен быть установлен Redis + Celery. Celery устанавливается через `pip install Celery` (Уже включено в requirements.txt). Для установки redis server изучите инструкцию для вашей ОС. Для ubuntu-подобных систем redis можно установить через `sudo apt install redis-server`.

В файле orders/settings.py найдите секцию "Настройки Celery":
```
# Настройки celery
CELERY_BROKER_URL = 'redis://localhost:6699'
CELERY_RESULT_BACKEND = 'redis://localhost:6699'
CELERY_ACCEPT_CONTENT = ['application/json']
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TASK_SERIALIZER = 'json'
```
Для работоспособности введите адрес вашего брокера сообщений Redis. 

После запуска redis-server запустить worker-а Celery можно путем выполнения следующей команды в корне проекта:
```
celery -A orders worker --loglevel=info

# Ключ loglevel можно исключить, если логирование не нужно
```
Теперь worker готов принимать задачи от системы API маркетплейса

**1.6 Тесты**

Для запуска встроенных тестов выполните в корне теста команду `pytest`

Пример результата:
```
(venv) ivan@ivan-MS-7C02:~/orders_diploma$ pytest
=================================== test session starts ===================================
platform linux -- Python 3.8.5, pytest-6.1.2, py-1.9.0, pluggy-0.13.1
django: settings: orders.settings (from ini)
rootdir: /home/ivan/orders_diploma, configfile: pytest.ini
plugins: django-4.1.0
collected 6 items                                                                                                                                                                                                                                        

market/views_tests.py ......                                                       [100%]

=================================== 6 passed in 0.65s ===================================
```



### 2. Настройка пользователей
**2.1. Создайте суперпользователя:**
```
python manage.py createsuperuser
```
**2.2. Запустите сервер**
```
python manage.py runserver
```

Остальные пользователи создаются путем отправки POST-запроса с ключами `username` и `password` на адрес 
```
http://hostname/signup/
```
Где hostname - адрес вашего хоста с запущенной системой, а username - адрес электронной почты пользователя, а password - пароль. По умолчанию пользователь будет создан как покупатель. Превратить покупателя в представителя магазина можно через веб-интерфейс администратора по адресу `http://hostname/admin/` путем изменения соответствующего параметра у пользователя.

### 3. Авторизация
**3.1. Логин**

После регистрации нужно залогиниться путем отправки через POST логина и пароля с ключами `username` и `password` по адресу:
 ```
http://hostname/signin/
```
В случае успешного логина вы будете перенаправлены на страницу успешного логина, на которой вам сообщат ваш `X-CSRFToken`. Данный токен необходимо включать в headers каждого последующего запроса от имени пользователя. В поле `key` введите В случае успешного логина вы будете перенаправлены на страницу успешного логина, на которой вам сообщат ваш `X-CSRFToken`. Данный токен необходимо включать в headers каждого последующего запроса от имени пользователя. В поле `key` введите `X-CSRFToken`, в поле `value` - сам токен.

**3.2 Выход из системы**

Для выхода из системы отправьте пустой GET-запрос (не забудьте включить `X-CSRFToken` в headers!) на адрес:
```
http://hostname/signout/
```
В случае успешного выхода из системы вы увидите подтверждающее сообщение.
С этого момента текущий токен перестанет действовать, для взаимодействия с системой придется залогиниться заново и получить новый токен.
### 4. Взаимодействие с API
**4.1. Обновление прайса поставщиком**

Чтобы обновить прайс-лист, отправьте POST-запрос на адрес:
```
http://hostname/partner_update/
```
В ключе `data` запроса передайте данные для обновления в формате YAML. Примеры данных для двух магазинов включены в данном репозитории в файлах `shop1.yaml` и `shop2.yaml`.

Можно отправить как файл, так и текст из файла - система определит тип автоматически.

Если такого магазина еще нет в базе, он будет создан автоматически, а текущий пользователь будет привязан к этому магазину.

Обратите внимание, что у магазина может быть только один администратор, а один пользователь может обновлять данные только одного магазина.

**4.2 Список товаров, категорий и магазинов**

Список товаров маркетплейса можно загрузить, отправив пустой GET-запрос на главную страницу:
```
http://hostname/
```
Товары выводятся с пагинацией по 5 штук. В запросе можно указать следующие параметры:

`page=int` - где int - положительное число - выведет страницу с соответствующим номером

**4.2.1.**   Обратившись по адресам `http://hostname/shops` и `http://hostname/categories` вы получите, соответственно, списки магазинов и категорий. Добавив после запроса идентификатор магазина или категории, вы получите карточку соответствующего магазина или категории, например:
```
http://hostname/shops/1
http://hostname/categories/15
```


**4.3 Карточка товара, добавление в корзину**

Карточку отдельного товара можно получить, отправив GET-запрос по адресу:
```
http://hostname/product/id
```
Где id - идентификатор продукта.

GET-запрос с параметром `add_to_cart=1` добавит данный товар в корзину

**4.4 Работа с корзиной**

Ваша корзина доступна через GET-запрос по адресу:
```
http://hostname/cart/
```
Корзина редактируется путем отправки POST-запросов на этот же адрес. Ключи запроса:

`id` - Указывает идентификатор товара, который вы хотите отредактировать

`quantity` - количество товара. При количестве, равном 0 или меньше товар будет удален из корзины.

Оба ключа должны быть в запросе одновременно.

Корзина хранится в сессии и в базе данных для возможности работы с разных устройств. Корзина в сессии имеет приоритет над корзиной в базе данных, то есть если вы добавили товары в корзину, а потом залогинились, предыдущая корзина из базы данных будет стерта и заменена более свежей из сессии.

**4.5 Список контактов**

У каждого пользователя может быть более одного адреса для отправки товаров, но для оформления заказа нужно, чтобы был заполнен хотя бы один адрес, поэтому лучше заполнить эту информацию заблаговременно. Альтернативный вариант - отображать на Frontend информацию о заказе и об адресе одновременно, но запрос на адрес направлять раньше подтверждения заказа.

Адрес для работы с контактами:
```
http://hostname/contacts/
```
GET-запрос по этому адресу покажет существующие у пользователя контакты. Если контактов нет, будет выведена соответствующая ошибка
Редактирование и добавление контактов происходит через POST-запрос с ключами:

`contact_id` - Идентификатор контактов. Если указан, будет отредактирован существующий список контактов. Если не указан, то будет создан новый список.

`city` - Город. Обязательный параметр.

`street` - Улица. Обязательный параметр.

`house` - Номер дома. Обязательный параметр.

`phone` - Номер телефона. Обязательный параметр.

`structure`, `building`, `apartment` - Номера зданий, строений, квартиры - необязательные параметры.

**4.6 Оформление заказа**

Для оформления заказа есть следующий адрес:
```
http://hostname/place_order/
```
GET-запрос по этому адресу вернет тот состав корзины, который планируется к заказу

Для оформления заказа передайте по этому адресу POST-запрос с ключами:

`order` - При значении истины (любое значение кроме 0) даст системе сигнал оформить заказ

`contact_id` - Идентификатор списка контактов, на который будет оформлен заказ. Если не передать данный параметр, будет использован самый новый список контактов.

Если у пользователя нет ни одного списка контактов / адреса доставки, то заказ не будет подтвержден и оформлен.

В случае успешного оформления заказа, вы получите сообщение о его подтверждении. Соответствующее письмо будет отправлено на почту.

**4.7 Просмотр заказов**

Для работы с заказами обратитесь по адресу:
```
http://hostname/order_list/
```

GET-запрос вернет список всех заказов пользователя. 

Параметр `id` в GET-запросе передает идентификатор одного заказа, карточку которого вы хотите вывести через API.

### 5 Ограничения

В системе предусмотрены ограничения по количеству запросов к API. Для анонимных пользователей количество запросов к API не может составлять более 15 в минуту. Для зарегистрированных пользователей - не более 1 запроса каждую секунду (60 запросов в минуту, равномерно распределенных во времени).